{% extends "base.html" %}

{% block title %}Rate Question - Question Feedback{% endblock %}

{% block content %}
<div class="container">
    <div class="page-header">
        <h1>Rate This Question</h1>
        <button type="button" class="btn-icon" id="regenerate-btn" title="Regenerate role & question">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M21 2v6h-6"></path>
                <path d="M3 12a9 9 0 0 1 15-6.7L21 8"></path>
                <path d="M3 22v-6h6"></path>
                <path d="M21 12a9 9 0 0 1-15 6.7L3 16"></path>
            </svg>
            <span id="regenerate-text">Regenerate</span>
        </button>
    </div>

    <h3 class="section-header">Job Description</h3>
    <section class="role-info" id="role-info-section">
        <div class="role-field">
            <label class="role-field-label">Job Title</label>
            <h2 class="editable-field" contenteditable="true" data-field="title" data-placeholder="Role title...">{{ role.title }}</h2>
        </div>
        <div class="role-field-row">
            <div class="role-field role-field-inline">
                <label class="role-field-label">Level</label>
                <span class="badge editable-field" contenteditable="true" data-field="level" data-placeholder="Level">{{ role.level }}</span>
            </div>
            <div class="role-field role-field-inline">
                <label class="role-field-label">Focus</label>
                <span class="badge editable-field" contenteditable="true" data-field="focus" data-placeholder="Focus">{{ role.focus }}</span>
            </div>
        </div>

        <div class="role-field">
            <label class="role-field-label">Tech Stack</label>
            <div class="tag-input-container" data-field="stack" id="stack-tags">
                {% for tech in role.stack %}
                <span class="tag" data-value="{{ tech }}">{{ tech }}<button type="button" class="tag-remove">&times;</button></span>
                {% endfor %}
                <input type="text" class="tag-input" placeholder="Add technology..." id="stack-input">
            </div>
        </div>

        <div class="role-field">
            <label class="role-field-label">Description</label>
            <div class="editable-field block" contenteditable="true" data-field="description" data-placeholder="Add description...">{{ role.description }}</div>
        </div>

        <div class="role-field">
            <label class="role-field-label">Key Skills</label>
            <div class="tag-input-container" data-field="skills" id="skills-tags">
                {% for skill in role.key_skills %}
                <span class="tag" data-value="{{ skill }}">{{ skill }}<button type="button" class="tag-remove">&times;</button></span>
                {% endfor %}
                <input type="text" class="tag-input" placeholder="Add skill..." id="skills-input">
            </div>
        </div>
    </section>

    <h3 class="section-header">Generated Question</h3>
    <section class="question-display" id="question-display-section">
        <div class="question-header">
            <button type="button" class="btn-icon" id="toggle-custom" title="Write your own question">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M12 20h9"></path>
                    <path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"></path>
                </svg>
                Write Own
            </button>
        </div>
        <div id="generated-section">
            <span class="edit-hint">Edit the question below if needed</span>
            <textarea id="question-editor" name="question_editor">{{ question }}</textarea>
        </div>
        <div id="custom-section" class="hidden">
            <span class="edit-hint">Write your own technical question for this role</span>
            <textarea id="custom-editor" name="custom_editor" placeholder="Type your custom technical screening question here..."></textarea>
        </div>
    </section>

    <h3 class="section-header">Evaluation</h3>
    <form action="/submit" method="POST" class="rating-form" id="rating-form">
        <input type="hidden" name="question" id="question-hidden" value="{{ question }}">
        <input type="hidden" name="source" id="source-hidden" value="generated">
        <input type="hidden" name="role_context" id="role-context-hidden" value="{{ role_json }}">
        <input type="hidden" name="role_id" value="{{ role.id }}">

        <div class="rating-group">
            <label class="rating-label">
                <span class="rating-title">Relevance</span>
                <span class="rating-desc">Does this question test skills actually needed for the role?</span>
            </label>
            <div class="radio-group">
                {% for i in range(0, 11) %}
                <label class="radio-label">
                    <input type="radio" name="relevance" value="{{ i }}" required>
                    <span class="radio-value">{{ i }}</span>
                </label>
                {% endfor %}
            </div>
            <div class="scale-labels">
                <span>Poor</span>
                <span>Excellent</span>
            </div>
        </div>

        <div class="rating-group">
            <label class="rating-label">
                <span class="rating-title">Clarity</span>
                <span class="rating-desc">Is the question unambiguous and well-formed?</span>
            </label>
            <div class="radio-group">
                {% for i in range(0, 11) %}
                <label class="radio-label">
                    <input type="radio" name="clarity" value="{{ i }}" required>
                    <span class="radio-value">{{ i }}</span>
                </label>
                {% endfor %}
            </div>
            <div class="scale-labels">
                <span>Poor</span>
                <span>Excellent</span>
            </div>
        </div>

        <div class="rating-group">
            <label class="rating-label">
                <span class="rating-title">Discriminative Power</span>
                <span class="rating-desc">Would this question distinguish good candidates from weak ones?</span>
            </label>
            <div class="radio-group">
                {% for i in range(0, 11) %}
                <label class="radio-label">
                    <input type="radio" name="discriminative" value="{{ i }}" required>
                    <span class="radio-value">{{ i }}</span>
                </label>
                {% endfor %}
            </div>
            <div class="scale-labels">
                <span>Poor</span>
                <span>Excellent</span>
            </div>
        </div>

        <div class="comment-group">
            <label for="comments">Comments (optional):</label>
            <textarea name="comments" id="comments" rows="3" placeholder="Any additional feedback about this question..."></textarea>
        </div>

        <div class="button-group">
            <button type="submit" class="btn btn-primary">Submit & Next Question</button>
            <a href="/" class="btn btn-secondary">Skip (New Question)</a>
        </div>
    </form>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Editor configuration
    const editorConfig = {
        spellChecker: false,
        autofocus: false,
        status: false,
        minHeight: '120px',
        toolbar: [
            'bold', 'italic', 'heading', '|',
            'code', 'quote', '|',
            'unordered-list', 'ordered-list', '|',
            'preview', 'side-by-side', '|',
            'guide'
        ],
        previewClass: ['editor-preview', 'markdown-body'],
        renderingConfig: {
            singleLineBreaks: false,
            codeSyntaxHighlighting: true
        }
    };

    // Initialize generated question editor
    const generatedEditor = new EasyMDE({
        ...editorConfig,
        element: document.getElementById('question-editor'),
        placeholder: 'Edit the generated question...'
    });

    // Initialize custom question editor
    const customEditor = new EasyMDE({
        ...editorConfig,
        element: document.getElementById('custom-editor'),
        placeholder: 'Type your custom technical screening question here...'
    });

    // State
    let isCustomMode = false;

    // DOM elements
    const generatedSection = document.getElementById('generated-section');
    const customSection = document.getElementById('custom-section');
    const toggleBtn = document.getElementById('toggle-custom');
    const sourceHidden = document.getElementById('source-hidden');
    const questionHidden = document.getElementById('question-hidden');

    // Toggle between generated and custom mode
    toggleBtn.addEventListener('click', function() {
        isCustomMode = !isCustomMode;

        if (isCustomMode) {
            generatedSection.classList.add('hidden');
            customSection.classList.remove('hidden');
            toggleBtn.innerHTML = `
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M21 2v6h-6"></path>
                    <path d="M3 12a9 9 0 0 1 15-6.7L21 8"></path>
                    <path d="M3 22v-6h6"></path>
                    <path d="M21 12a9 9 0 0 1-15 6.7L3 16"></path>
                </svg>
                Use Generated
            `;
            sourceHidden.value = 'user_provided';
            customEditor.codemirror.refresh();
        } else {
            customSection.classList.add('hidden');
            generatedSection.classList.remove('hidden');
            toggleBtn.innerHTML = `
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M12 20h9"></path>
                    <path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"></path>
                </svg>
                Write Own
            `;
            sourceHidden.value = 'generated';
            generatedEditor.codemirror.refresh();
        }
    });

    // Get original role data
    let currentRoleContext = JSON.parse(document.getElementById('role-context-hidden').value);
    const roleContextHidden = document.getElementById('role-context-hidden');

    // Regenerate button functionality
    const regenerateBtn = document.getElementById('regenerate-btn');
    const regenerateText = document.getElementById('regenerate-text');

    regenerateBtn.addEventListener('click', async function() {
        // Show loading state
        regenerateBtn.classList.add('loading');
        regenerateText.textContent = 'Loading...';

        try {
            // Fetch new role and question
            const response = await fetch('/api/regenerate?new_role=true');
            const data = await response.json();

            // Update role info
            currentRoleContext = data.role;
            document.querySelector('[data-field="title"]').textContent = data.role.title;
            document.querySelector('[data-field="level"]').textContent = data.role.level;
            document.querySelector('[data-field="focus"]').textContent = data.role.focus || data.role.domain || '';
            document.querySelector('[data-field="description"]').textContent = data.role.description;

            // Update tags
            updateTags('stack-tags', 'stack-input', data.role.stack || []);
            updateTags('skills-tags', 'skills-input', data.role.key_skills || []);

            // Update hidden form fields
            roleContextHidden.value = JSON.stringify(data.role);
            document.querySelector('[name="role_id"]').value = data.role.id;

            // Update question editor
            generatedEditor.value(data.question);
            questionHidden.value = data.question;

            // Reset to generated mode if in custom mode
            if (isCustomMode) {
                toggleBtn.click();
            }

            // Flash effect on updated sections
            document.getElementById('role-info-section').style.animation = 'none';
            document.getElementById('role-info-section').offsetHeight; // Trigger reflow
            document.getElementById('role-info-section').style.animation = 'fadeIn 0.3s ease-out';

            document.getElementById('question-display-section').style.animation = 'none';
            document.getElementById('question-display-section').offsetHeight;
            document.getElementById('question-display-section').style.animation = 'fadeIn 0.3s ease-out';

        } catch (error) {
            console.error('Failed to regenerate:', error);
            alert('Failed to regenerate. Please try again.');
        } finally {
            // Reset button state
            regenerateBtn.classList.remove('loading');
            regenerateText.textContent = 'Regenerate';
        }
    });

    // ===== TAG INPUT MANAGEMENT =====
    function initTagInput(containerId, inputId) {
        const container = document.getElementById(containerId);
        const input = document.getElementById(inputId);

        // Add tag function
        function addTag(value) {
            value = value.trim();
            if (!value) return;

            // Check if tag already exists
            const existingTags = container.querySelectorAll('.tag');
            for (const tag of existingTags) {
                if (tag.dataset.value.toLowerCase() === value.toLowerCase()) {
                    return; // Don't add duplicate
                }
            }

            const tag = document.createElement('span');
            tag.className = 'tag';
            tag.dataset.value = value;
            tag.innerHTML = `${value}<button type="button" class="tag-remove">&times;</button>`;
            container.insertBefore(tag, input);
            input.value = '';
        }

        // Handle input keydown
        input.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' || e.key === ',') {
                e.preventDefault();
                addTag(input.value);
            } else if (e.key === 'Backspace' && input.value === '') {
                // Remove last tag on backspace if input is empty
                const tags = container.querySelectorAll('.tag');
                if (tags.length > 0) {
                    tags[tags.length - 1].remove();
                }
            }
        });

        // Handle blur to add tag
        input.addEventListener('blur', function() {
            if (input.value.trim()) {
                addTag(input.value);
            }
        });

        // Handle click on container to focus input
        container.addEventListener('click', function(e) {
            if (e.target === container) {
                input.focus();
            }
        });

        // Handle remove button clicks (event delegation)
        container.addEventListener('click', function(e) {
            if (e.target.classList.contains('tag-remove')) {
                e.target.parentElement.remove();
            }
        });
    }

    // Initialize tag inputs
    initTagInput('stack-tags', 'stack-input');
    initTagInput('skills-tags', 'skills-input');

    // Get tags from a container
    function getTagValues(containerId) {
        const container = document.getElementById(containerId);
        const tags = container.querySelectorAll('.tag');
        return Array.from(tags).map(tag => tag.dataset.value);
    }

    // Update tags in a container (for regenerate)
    function updateTags(containerId, inputId, values) {
        const container = document.getElementById(containerId);
        const input = document.getElementById(inputId);

        // Remove all existing tags
        container.querySelectorAll('.tag').forEach(tag => tag.remove());

        // Add new tags
        values.forEach(value => {
            const tag = document.createElement('span');
            tag.className = 'tag';
            tag.dataset.value = value;
            tag.innerHTML = `${value}<button type="button" class="tag-remove">&times;</button>`;
            container.insertBefore(tag, input);
        });
    }

    // Collect editable field values
    function collectEditedRoleContext() {
        const editedContext = { ...currentRoleContext };

        // Get simple editable fields
        document.querySelectorAll('.editable-field[data-field]').forEach(field => {
            const fieldName = field.dataset.field;
            const value = field.textContent.trim();

            if (fieldName === 'title') {
                editedContext.title = value;
            } else if (fieldName === 'level') {
                editedContext.level = value;
            } else if (fieldName === 'focus') {
                editedContext.focus = value;
            } else if (fieldName === 'description') {
                editedContext.description = value;
            }
        });

        // Get tag values
        editedContext.stack = getTagValues('stack-tags');
        editedContext.key_skills = getTagValues('skills-tags');

        return editedContext;
    }

    // Sync editor content to hidden form field on submit
    document.getElementById('rating-form').addEventListener('submit', function(e) {
        // Sync question
        if (isCustomMode) {
            questionHidden.value = customEditor.value();
        } else {
            questionHidden.value = generatedEditor.value();
        }

        // Sync edited role context
        roleContextHidden.value = JSON.stringify(collectEditedRoleContext());
    });

    // Prevent enter key from creating new lines in single-line fields
    document.querySelectorAll('.editable-field[data-field="title"], .editable-field[data-field="level"], .editable-field[data-field="focus"]').forEach(field => {
        field.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                field.blur();
            }
        });
    });
});
</script>
{% endblock %}
